<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Thi·ªáp Gi√°ng Sinh ‚Äî Si√™u C·∫•p üéÑ‚ú®</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Great+Vibes&display=swap" rel="stylesheet">

  <!-- Export PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg0:#020617;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --radius: 26px;
      --accent1:#22c55e;
      --accent2:#60a5fa;
      --accent3:#f472b6;
      --gold:#fbbf24;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 30% 10%, rgba(34,197,94,.16), transparent 65%),
                  radial-gradient(900px 800px at 80% 30%, rgba(96,165,250,.14), transparent 60%),
                  radial-gradient(800px 800px at 60% 90%, rgba(244,114,182,.10), transparent 55%),
                  linear-gradient(180deg, #041018, var(--bg0));
      overflow-x:hidden;
    }

    /* Video background */
    .bg-video{
      position:fixed; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      filter: saturate(1.1) contrast(1.05) brightness(.75);
      transform: scale(1.03);
      z-index:-3;
    }
    .vignette{
      position:fixed; inset:0;
      background:
        radial-gradient(1100px 700px at 35% 15%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 600px at 70% 30%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(1200px 900px at 50% 110%, rgba(0,0,0,.65), rgba(0,0,0,.85)),
        linear-gradient(180deg, rgba(2,6,23,.35), rgba(2,6,23,.70));
      z-index:-2;
      pointer-events:none;
    }

    /* Soft animated aurora blobs */
    .aurora{
      position:fixed; inset:-20vh -10vw;
      z-index:-1;
      pointer-events:none;
      filter: blur(40px);
      opacity:.75;
      mix-blend-mode: screen;
    }
    .blob{
      position:absolute;
      width:44vw; height:44vw;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.55), transparent 55%),
                  radial-gradient(circle at 60% 60%, rgba(96,165,250,.45), transparent 55%),
                  radial-gradient(circle at 50% 20%, rgba(244,114,182,.35), transparent 60%);
      animation: drift 14s ease-in-out infinite alternate;
      transform: translate3d(0,0,0);
    }
    .blob.b2{ left:55%; top:5%; width:46vw; height:46vw; animation-duration: 18s; opacity:.8 }
    .blob.b3{ left:12%; top:55%; width:50vw; height:50vw; animation-duration: 22s; opacity:.65 }
    @keyframes drift{
      from{ transform: translate3d(-3%, -2%, 0) scale(1) rotate(0deg) }
      to{ transform: translate3d(4%, 3%, 0) scale(1.06) rotate(10deg) }
    }

    /* Layout */
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px 44px}
    .top{
      display:flex; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      gap:14px; margin-top:6px;
    }
    .title{
      display:flex; flex-direction:column; gap:8px;
    }
    .badges{display:flex;flex-wrap:wrap;gap:10px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      font-size:13px;
      user-select:none;
    }
    h1{
      margin:0;
      font-size: clamp(30px, 3.2vw, 44px);
      letter-spacing:-.03em;
      line-height:1.05;
      text-shadow: 0 12px 40px rgba(0,0,0,.55);
    }
    .subtitle{
      margin:0;
      color: rgba(229,231,235,.78);
      line-height:1.55;
      max-width: 58ch;
    }

    .actions{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:10px 14px;
      border-radius: 18px;
      cursor:pointer;
      font-weight:700;
      transition: transform .12s ease, background .18s ease, box-shadow .18s ease;
      box-shadow: 0 18px 50px rgba(0,0,0,.30);
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.14) }
    .btn:active{ transform: translateY(1px) }
    .btn.primary{
      background: rgba(255,255,255,.92);
      color:#0b1220;
      border-color: transparent;
    }
    .btn.primary:hover{ background:#fff }
    .btn.gold{
      background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(245,158,11,.92));
      color:#111827;
      border-color: transparent;
    }
    .btn.ghost{
      background: rgba(0,0,0,.25);
    }

    /* Segmented nav */
    .nav{
      margin-top: 16px;
      display:flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(12px);
      border-radius: 999px;
      padding:6px;
      width: fit-content;
      box-shadow: 0 22px 70px rgba(0,0,0,.35);
    }
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:0;
      background: transparent;
      color: rgba(229,231,235,.8);
      cursor:pointer;
      font-weight:700;
      transition: .18s;
    }
    .tab.active{
      background: rgba(255,255,255,.14);
      color: var(--text);
    }

    /* Grid */
    .grid{display:grid; gap:16px; margin-top:16px}
    @media (min-width: 960px){
      .grid{grid-template-columns: 410px 1fr}
    }

    /* Panels / cards */
    .panel, .card{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .panel{padding:16px}
    .panel::before, .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(96,165,250,.14), rgba(244,114,182,.12));
      filter: blur(26px);
      opacity:.55;
      pointer-events:none;
    }
    .panel > * , .card > *{ position:relative; z-index:1 }

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 12px;
    }
    .sectionTitle .left{
      display:flex; flex-direction:column; gap:2px;
    }
    .sectionTitle h2{
      margin:0; font-size:14px; letter-spacing:.02em; text-transform:uppercase;
      color: rgba(229,231,235,.85);
    }
    .sectionTitle p{ margin:0; font-size:12px; color: rgba(156,163,175,.9) }

    label{display:block; font-size:13px; margin-bottom:6px; color: rgba(229,231,235,.90)}
    input, select, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      border-radius: 18px;
      padding: 10px 12px;
      outline:none;
      transition: border .18s, box-shadow .18s, transform .12s;
    }
    textarea{min-height:112px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(255,255,255,.08);
    }
    .row{display:flex; gap:10px}
    .col{flex:1}

    .hint{font-size:12px; color: rgba(156,163,175,.95); margin-top:6px; line-height:1.45}
    .sep{height:1px;background:rgba(255,255,255,.10); margin:12px 0}

    /* Switch */
    .switch{
      width:46px; height:28px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      position:relative; cursor:pointer;
      flex: 0 0 auto;
    }
    .knob{
      position:absolute; top:3px; left:3px;
      width:22px; height:22px; border-radius:999px;
      background: #fff;
      transition: .18s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .switch[data-on="true"]{
      background: rgba(34,197,94,.22);
      border-color: rgba(34,197,94,.35);
    }
    .switch[data-on="true"] .knob{ left:21px }

    /* Range */
    input[type="range"]{
      padding:0; height: 28px;
      background: transparent;
      border:0;
      box-shadow:none;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:6px; border-radius:999px;
      background: rgba(255,255,255,.16);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:18px; height:18px; border-radius:999px;
      background:#fff; margin-top:-6px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border: 0;
    }

    /* Stage transitions */
    .stage{
      display:none;
      opacity:0;
      transform: translateY(10px) scale(.99);
      transition: opacity .35s ease, transform .45s cubic-bezier(.2,.9,.2,1);
    }
    .stage.active{
      display:block;
      opacity:1;
      transform: translateY(0) scale(1);
    }

    /* Card 3D flip */
    .card{
      min-height: 520px;
      padding:0;
    }
    .cardInner{
      position:relative;
      padding:18px;
    }
    @media (min-width: 960px){
      .cardInner{padding:22px}
    }

    .flipWrap{
      perspective: 1200px;
      position:relative;
    }
    .flip{
      position:relative;
      transform-style: preserve-3d;
      transition: transform .75s cubic-bezier(.2,.9,.2,1);
    }
    .flip.flipped{ transform: rotateY(180deg) }
    .side{
      backface-visibility:hidden;
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(145deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      overflow:hidden;
      position:relative;
    }
    .front{ padding:22px }
    @media (min-width: 960px){ .front{ padding:32px } }
    .back{
      position:absolute; inset:0;
      transform: rotateY(180deg);
      padding:22px;
    }
    @media (min-width: 960px){ .back{ padding:32px } }

    /* Fancy ornaments */
    .ornament{
      position:absolute;
      width:260px; height:260px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 60%),
                  radial-gradient(circle at 55% 60%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(circle at 40% 70%, rgba(96,165,250,.16), transparent 60%);
      filter: blur(10px);
      opacity:.70;
      right:-110px; top:-110px;
      pointer-events:none;
      animation: floaty 6.5s ease-in-out infinite alternate;
    }
    .ornament.o2{ left:-130px; bottom:-130px; right:auto; top:auto; width:300px; height:300px; opacity:.60; animation-duration: 8.2s }
    @keyframes floaty{ from{ transform: translateY(0) } to{ transform: translateY(14px) } }

    .snowCanvas, .sparkCanvas, .confettiCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      pointer-events:none;
    }

    /* Card content */
    .header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .sendto{margin:0; font-size:13px; color: rgba(156,163,175,.95)}
    .toName{
      margin:4px 0 0;
      font-size: clamp(24px, 2.2vw, 34px);
      letter-spacing:-.02em;
      text-shadow: 0 12px 50px rgba(0,0,0,.45);
    }
    .icons{display:flex; gap:10px}
    .iconBox{
      width:42px; height:42px; border-radius:16px;
      display:grid; place-items:center;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 16px 50px rgba(0,0,0,.25);
    }

    .messageBox{
      margin-top:18px;
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      padding: 16px 16px 14px;
      position:relative;
      overflow:hidden;
    }
    .messageBox::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(34,197,94,.20), rgba(96,165,250,.14), rgba(244,114,182,.12));
      filter: blur(26px);
      opacity:.35;
      pointer-events:none;
    knowing: blur(10px);
      mask-image: radial-gradient(circle at 30% 30%, black 25%, transparent 70%);
      opacity:.55;
    }
    .msg{
      position:relative; z-index:1;
      margin:0;
      white-space:pre-wrap;
      line-height:1.7;
      font-size: 16px;
      color: rgba(229,231,235,.95);
    }
    .signature{
      position:relative; z-index:1;
      margin-top: 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color: rgba(156,163,175,.95);
      font-size: 13px;
    }
    .signature strong{ color: rgba(229,231,235,.95) }

    .script{
      font-family: "Great Vibes", cursive;
      font-size: 30px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 16px 60px rgba(0,0,0,.55);
      margin: 6px 0 0;
    }

    .mini{
      margin-top:14px;
      display:grid; gap:10px;
    }
    @media (min-width: 760px){ .mini{grid-template-columns: repeat(3, 1fr)} }
    .tile{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .tile h3{margin:0 0 6px; font-size:13px}
    .tile p{margin:0; font-size:12px; color: rgba(156,163,175,.95); line-height:1.45}

    /* Back side content */
    .backTitle{
      font-size:14px; letter-spacing:.08em; text-transform:uppercase;
      color: rgba(229,231,235,.85); margin:0 0 8px;
    }
    .backBox{
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      padding: 14px;
    }
    .backBox p{margin:0; color: rgba(229,231,235,.92); line-height:1.7}
    .qrFake{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stamp{
      border-radius: 22px;
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
      padding: 12px;
    }
    .stamp small{color: rgba(156,163,175,.95)}
    .stamp b{display:block; margin-top:6px}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:16px;
      transform: translateX(-50%) translateY(8px);
      background: rgba(2,6,23,.84);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(12px);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 16px;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      opacity:0; pointer-events:none;
      transition: .18s ease;
      z-index:50;
      font-size: 13px;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    footer{
      margin-top: 16px;
      text-align:center;
      color: rgba(156,163,175,.80);
      font-size: 12px;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .blob{animation:none}
      .stage{transition:none}
      .flip{transition:none}
    }
  </style>
</head>

<body>
  <!-- Video background (CDN - c√≥ th·ªÉ ƒë·ªïi link video kh√°c) -->
  <video class="bg-video" autoplay muted loop playsinline
    src="https://cdn.coverr.co/videos/coverr-christmas-lights-9716/1080p.mp4"></video>
  <div class="vignette"></div>
  <div class="aurora" aria-hidden="true">
    <div class="blob b1" style="left:6%; top:10%"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>

  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="badges">
          <div class="badge">üé¨ Video n·ªÅn</div>
          <div class="badge">üßä Tuy·∫øt + sparkle</div>
          <div class="badge">üßß Confetti + flip 3D</div>
          <div class="badge">üñºÔ∏è Export PNG</div>
        </div>
        <h1>Thi·ªáp Gi√°ng Sinh ‚Äî Si√™u C·∫•p üéÑ‚ú®</h1>
        <p class="subtitle">
          Ch·ªçn m·∫´u, chuy·ªÉn c·∫£nh m∆∞·ª£t, flip thi·ªáp 3D, ‚Äúm·ªü qu√†‚Äù n·ªï confetti, c√≥ nh·∫°c v√† t·∫£i PNG. 1 file HTML ch·∫°y th·∫≥ng GitHub Pages.
        </p>

        <div class="nav" role="tablist" aria-label="Chuy·ªÉn c·∫£nh">
          <button class="tab active" id="tabEdit" role="tab" aria-selected="true">üéõÔ∏è T·∫°o thi·ªáp</button>
          <button class="tab" id="tabView" role="tab" aria-selected="false">ü™Ñ Xem thi·ªáp</button>
          <button class="tab" id="tabShare" role="tab" aria-selected="false">üîó Chia s·∫ª</button>
        </div>
      </div>

      <div class="actions">
        <button id="recordBtn">üé¨ T·∫°o video (6s)</button>
        <button class="btn ghost" id="musicBtn">üéµ Nh·∫°c: OFF</button>
        <button class="btn" id="copyBtn">üìã Copy l·ªùi ch√∫c</button>
        <button class="btn primary" id="downloadBtn">‚¨áÔ∏è T·∫£i PNG</button>
        <button class="btn gold" id="giftBtn">üéÅ M·ªü qu√†</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Controls -->
      <div class="panel">
        <div class="sectionTitle">
          <div class="left">
            <h2>Tu·ª≥ ch·ªânh</h2>
            <p>ƒê·ªïi n·ªôi dung + hi·ªáu ·ª©ng (si√™u m∆∞·ª£t)</p>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <span style="font-size:12px;color:rgba(156,163,175,.9)">Tuy·∫øt</span>
            <div class="switch" id="snowSwitch" data-on="true" role="switch" aria-checked="true" tabindex="0"><div class="knob"></div></div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ng∆∞·ªùi nh·∫≠n</label>
            <input id="toInput" value="B·∫°n" placeholder="V√≠ d·ª•: Linh" />
          </div>
          <div class="col">
            <label>Ng∆∞·ªùi g·ª≠i</label>
            <input id="fromInput" value="M√¨nh" placeholder="V√≠ d·ª•: Phong" />
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Ch·ªçn m·∫´u l·ªùi ch√∫c</label>
          <select id="templateSelect"></select>
          <div class="hint">B·∫°n c√≥ th·ªÉ d√πng <b>{to}</b> v√† <b>{from}</b> trong l·ªùi ch√∫c.</div>
        </div>

        <div style="margin-top:12px">
          <label>L·ªùi ch√∫c tu·ª≥ bi·∫øn (kh√¥ng b·∫Øt bu·ªôc)</label>
          <textarea id="customInput" placeholder="G√µ l·ªùi ch√∫c ri√™ng‚Ä¶ (c√≥ th·ªÉ d√πng {to} v√† {from})"></textarea>
          <div class="hint">Tip: Vi·∫øt xu·ªëng d√≤ng ƒë·ªÉ thi·ªáp nh√¨n ‚Äúx·ªãn‚Äù h∆°n ‚ú®</div>
        </div>

        <div class="sep"></div>

        <div class="row" style="align-items:center">
          <div class="col">
            <label style="margin:0">M·∫≠t ƒë·ªô tuy·∫øt</label>
            <div class="hint">ƒêang: <span id="densityLabel">90</span></div>
          </div>
          <div class="col">
            <input id="densityRange" type="range" min="30" max="160" value="90" />
          </div>
        </div>

        <div class="row" style="align-items:center; margin-top:10px">
          <div class="col">
            <label style="margin:0">Sparkle (√°nh sao)</label>
            <div class="hint">Hi·ªáu ·ª©ng l·∫•p l√°nh ‚Äúsi√™u c·∫•p‚Äù</div>
          </div>
          <div class="switch" id="sparkSwitch" data-on="true" role="switch" aria-checked="true" tabindex="0"><div class="knob"></div></div>
        </div>

        <div class="row" style="align-items:center; margin-top:10px">
          <div class="col">
            <label style="margin:0">Flip 3D</label>
            <div class="hint">B·∫•m v√†o thi·ªáp ƒë·ªÉ l·∫≠t m·∫∑t sau</div>
          </div>
          <div class="switch" id="flipSwitch" data-on="true" role="switch" aria-checked="true" tabindex="0"><div class="knob"></div></div>
        </div>

        <div class="sep"></div>

        <div class="hint">
          üí° <b>M·∫πo share ‚Äúx·ªãn‚Äù</b>: M·ªü tab ‚ÄúChia s·∫ª‚Äù ƒë·ªÉ t·∫°o link c√≥ s·∫µn t√™n ng∆∞·ªùi nh·∫≠n: <code>?to=Linh&from=Phong</code>
        </div>
      </div>

      <!-- RIGHT: Stages -->
      <div>
        <!-- Stage: View (default also shows in Edit for preview) -->
        <div class="stage active" id="stageEdit">
          <div class="card" id="cardCapture">
            <div class="cardInner">
              <div class="flipWrap">
                <div class="flip" id="flip">
                  <!-- FRONT -->
                  <div class="side front" id="frontSide">
                    <canvas class="snowCanvas" id="snowCanvas"></canvas>
                    <canvas class="sparkCanvas" id="sparkCanvas"></canvas>
                    <canvas class="confettiCanvas" id="confettiCanvas"></canvas>
                    <div class="ornament"></div>
                    <div class="ornament o2"></div>

                    <div class="header">
                      <div>
                        <p class="sendto">G·ª≠i ƒë·∫øn</p>
                        <div class="toName" id="toText">B·∫°n</div>
                      </div>
                      <div class="icons">
                        <div class="iconBox">üéÑ</div>
                        <div class="iconBox">‚ú®</div>
                      </div>
                    </div>

                    <div class="messageBox">
                      <p class="msg" id="msgText"></p>
                      <div class="signature">
                        <div>T·ª´ <strong id="fromText">M√¨nh</strong></div>
                        <div id="dateText"></div>
                      </div>
                      <div class="script" id="scriptLine">Merry Christmas</div>
                    </div>

                    <div class="mini">
                      <div class="tile"><h3>ü™Ñ Chuy·ªÉn c·∫£nh</h3><p>Qua tab ‚ÄúXem thi·ªáp‚Äù ƒë·ªÉ full m√†n h√¨nh.</p></div>
                      <div class="tile"><h3>üéÅ M·ªü qu√†</h3><p>N·ªï confetti + rung nh·∫π (n·∫øu h·ªó tr·ª£).</p></div>
                      <div class="tile"><h3>‚¨áÔ∏è Export</h3><p>T·∫£i PNG ƒë·ªÉ g·ª≠i Zalo/Facebook.</p></div>
                    </div>
                  </div>

                  <!-- BACK -->
                  <div class="side back" id="backSide">
                    <canvas class="snowCanvas" id="snowCanvas2"></canvas>
                    <canvas class="sparkCanvas" id="sparkCanvas2"></canvas>
                    <div class="ornament"></div>
                    <div class="ornament o2"></div>

                    <div class="backTitle">M·∫∑t sau ‚Äî l·ªùi nh·∫Øn nh·ªè</div>
                    <div class="backBox">
                      <p id="backNote">
                        ‚ÄúGi√°ng Sinh l√† l√Ω do ƒë·ªÉ m√¨nh nh·∫Øc b·∫°n r·∫±ng: b·∫°n r·∫•t tuy·ªát.
                        Mong b·∫°n lu√¥n b√¨nh an, v√† nƒÉm m·ªõi s·∫Ω d·ªãu d√†ng v·ªõi b·∫°n.‚Äù ‚ú®
                      </p>
                      <div class="qrFake">
                        <div class="stamp">
                          <small>Ng∆∞·ªùi nh·∫≠n</small>
                          <b id="toStamp">B·∫°n</b>
                        </div>
                        <div class="stamp">
                          <small>Ng∆∞·ªùi g·ª≠i</small>
                          <b id="fromStamp">M√¨nh</b>
                        </div>
                      </div>
                    </div>
                    <div class="hint" style="margin-top:12px">
                      Tip: B·∫•m l·∫°i v√†o thi·ªáp ƒë·ªÉ <b>l·∫≠t v·ªÅ m·∫∑t tr∆∞·ªõc</b>.
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn" id="flipBtn">ü™Ñ L·∫≠t thi·ªáp</button>
                <button class="btn" id="fullBtn">üì∫ Xem full</button>
                <button class="btn" id="shakeBtn">üí• Rung ‚Äúwow‚Äù</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Stage: View -->
        <div class="stage" id="stageView">
          <div class="card">
            <div class="cardInner">
              <div class="hint" style="margin-bottom:10px">
                ‚úÖ ƒê√¢y l√† ch·∫ø ƒë·ªô xem ‚Äúfull vibe‚Äù. B·∫•m <b>Esc</b> ho·∫∑c tab kh√°c ƒë·ªÉ quay l·∫°i.
              </div>
              <div class="panel" style="padding:14px">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap">
                  <div>
                    <div style="font-weight:800; letter-spacing:-.02em">Xem thi·ªáp to√†n m√†n h√¨nh</div>
                    <div class="hint">G·ª£i √Ω: b·∫•m ‚ÄúM·ªü qu√†‚Äù ƒë·ªÉ n·ªï confetti üéÅ</div>
                  </div>
                  <div style="display:flex; gap:10px; flex-wrap:wrap">
                    <button class="btn" id="viewFlipBtn">ü™Ñ L·∫≠t thi·ªáp</button>
                    <button class="btn primary" id="viewDownloadBtn">‚¨áÔ∏è T·∫£i PNG</button>
                  </div>
                </div>
              </div>

              <div style="margin-top:12px" id="viewMirror"></div>
            </div>
          </div>
        </div>

        <!-- Stage: Share -->
        <div class="stage" id="stageShare">
          <div class="panel">
            <div class="sectionTitle" style="margin-bottom:8px">
              <div class="left">
                <h2>Chia s·∫ª</h2>
                <p>T·∫°o link auto ƒëi·ªÅn t√™n ng∆∞·ªùi nh·∫≠n</p>
              </div>
            </div>

            <div class="hint">Link c·ªßa b·∫°n (GitHub Pages):</div>
            <input id="baseUrl" readonly />

            <div class="sep"></div>

            <div class="hint">Link c√≥ s·∫µn t√™n (auto):</div>
            <input id="shareUrl" readonly />

            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn" id="copyLinkBtn">üîó Copy link</button>
              <button class="btn primary" id="openLinkBtn">üöÄ M·ªü link</button>
            </div>

            <div class="sep"></div>

            <div class="hint">
              V√≠ d·ª•: <code>?to=Linh&from=Phong</code> ‚Äî ai m·ªü link s·∫Ω th·∫•y s·∫µn t√™n v√† l·ªùi ch√∫c.
            </div>
          </div>

          <footer>
            N·∫øu mu·ªën m√¨nh ‚Äúƒë·ªô‚Äù th√™m: sticker bay, ch·ªØ neon, ph√°o hoa, nh·∫°c th·∫≠t‚Ä¶ n√≥i m√¨nh style b·∫°n th√≠ch (cute / romantic / ng·∫ßu).
          </footer>
        </div>
      </div>
    </div>

    <footer>
      Tip: N·∫øu export PNG b·ªã l·ªói do video, c·ª© export b√¨nh th∆∞·ªùng ‚Äî m√¨nh ƒë√£ set ch·∫ø ƒë·ªô ch·ª•p ch·ªâ card (kh√¥ng ph·ª• thu·ªôc video).
    </footer>
  </div>

  <div class="toast" id="toast">...</div>

  <audio id="bgMusic" preload="auto" loop
    src="https://cdn.pixabay.com/download/audio/2022/12/06/audio_3f1d87f2cf.mp3?filename=christmas-magic-121300.mp3">
  </audio>

  <script>
    // ---------- Templates ----------
    const TEMPLATES = [
      { id:"classic", title:"C·ªï ƒëi·ªÉn", text:"Ch√∫c {to} m·ªôt m√πa Gi√°ng Sinh an l√†nh, ·∫•m √°p b√™n gia ƒë√¨nh v√† nh·ªØng ng∆∞·ªùi th√¢n y√™u.\nNƒÉm m·ªõi th·∫≠t nhi·ªÅu s·ª©c kh·ªèe v√† ni·ªÅm vui! üéÑ" },
      { id:"sparkle", title:"L·∫•p l√°nh", text:"Merry Christmas {to}! ‚ú®\nCh√∫c b·∫°n lu√¥n r·ª±c r·ª°, g·∫∑p nhi·ªÅu may m·∫Øn v√† nh·ªØng ƒëi·ªÅu ng·ªçt ng√†o nh·∫•t trong nƒÉm m·ªõi!" },
      { id:"romantic", title:"Ng·ªçt ng√†o", text:"Gi√°ng Sinh n√†y, ch√∫c {to} lu√¥n b√¨nh y√™n.\nC·∫£m ∆°n v√¨ ƒë√£ l√†m nƒÉm c·ªßa m√¨nh ·∫•m √°p h∆°n r·∫•t nhi·ªÅu. ‚ù§Ô∏è" },
      { id:"funny", title:"Vui vui", text:"Merry Christmas {to}!\nCh√∫c b·∫°n qu√† ƒë·∫ßy tay, b·ª•ng ƒë·∫ßy b√°nh, ng·ªß m·ªôt gi·∫•c ngon v√†‚Ä¶ kh√¥ng tƒÉng c√¢n (n·∫øu ƒë∆∞·ª£c)! üéÅüòÇ" },
      { id:"coworker", title:"ƒê·ªìng nghi·ªáp", text:"Ch√∫c {to} Gi√°ng Sinh vui v·∫ª v√† nƒÉm m·ªõi b·ª©t ph√°!\nC·∫£m ∆°n v√¨ ƒë√£ ƒë·ªìng h√†nh v√† ph·ªëi h·ª£p tuy·ªát v·ªùi su·ªët nƒÉm qua. üöÄ" },
    ];

    const $ = (id) => document.getElementById(id);

    // Controls
    const toInput = $("toInput");
    const fromInput = $("fromInput");
    const templateSelect = $("templateSelect");
    const customInput = $("customInput");
    const densityRange = $("densityRange");
    const densityLabel = $("densityLabel");

    // Switches
    const snowSwitch = $("snowSwitch");
    const sparkSwitch = $("sparkSwitch");
    const flipSwitch = $("flipSwitch");

    // Tabs/stages
    const tabEdit = $("tabEdit"), tabView = $("tabView"), tabShare = $("tabShare");
    const stageEdit = $("stageEdit"), stageView = $("stageView"), stageShare = $("stageShare");

    // Card elements
    const toText = $("toText");
    const fromText = $("fromText");
    const msgText = $("msgText");
    const dateText = $("dateText");
    const scriptLine = $("scriptLine");

    const toStamp = $("toStamp");
    const fromStamp = $("fromStamp");

    // Buttons
    const copyBtn = $("copyBtn");
    const downloadBtn = $("downloadBtn");
    const giftBtn = $("giftBtn");
    const musicBtn = $("musicBtn");
    const flipBtn = $("flipBtn");
    const fullBtn = $("fullBtn");
    const shakeBtn = $("shakeBtn");
    const viewFlipBtn = $("viewFlipBtn");
    const viewDownloadBtn = $("viewDownloadBtn");

    const copyLinkBtn = $("copyLinkBtn");
    const openLinkBtn = $("openLinkBtn");

    // Flip
    const flip = $("flip");
    let flipEnabled = true;

    // Toast
    const toast = $("toast");
    const showToast = (t) => {
      toast.textContent = t;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
    };

    // Music
    const bgMusic = $("bgMusic");
    let musicOn = false;
    const setMusic = async(on) => {
      musicOn = !!on;
      musicBtn.textContent = musicOn ? "üéµ Nh·∫°c: ON" : "üéµ Nh·∫°c: OFF";
      try{
        if(musicOn){
          bgMusic.volume = 0.35;
          await bgMusic.play();
          showToast("Nh·∫°c ON üé∂");
        }else{
          bgMusic.pause();
          bgMusic.currentTime = 0;
          showToast("Nh·∫°c OFF");
        }
      }catch{
        musicOn = false;
        musicBtn.textContent = "üéµ Nh·∫°c: OFF";
        showToast("Tr√¨nh duy·ªát ch·∫∑n autoplay ‚Äî b·∫•m l·∫°i ƒë·ªÉ b·∫≠t");
      }
    };

    // URL param auto-fill
    const qs = new URLSearchParams(location.search);
    const qTo = qs.get("to");
    const qFrom = qs.get("from");
    if(qTo) toInput.value = qTo;
    if(qFrom) fromInput.value = qFrom;

    // Init templates
    for(const t of TEMPLATES){
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.title;
      templateSelect.appendChild(opt);
    }
    templateSelect.value = "sparkle";

    // Date
    dateText.textContent = new Date().toLocaleDateString("vi-VN");

    const clamp = (n,a,b) => Math.max(a, Math.min(b,n));

    const getTemplateText = () => {
      const id = templateSelect.value;
      return (TEMPLATES.find(t=>t.id===id) || TEMPLATES[0]).text;
    };

    const buildMessage = () => {
      const to = (toInput.value || "B·∫°n").trim();
      const from = (fromInput.value || "M√¨nh").trim();
      const base = (customInput.value.trim() ? customInput.value : getTemplateText())
        .replaceAll("{to}", to)
        .replaceAll("{from}", from);

      const msg = /[.!?‚Ä¶]$/.test(base.trim()) ? base : (base.trim() + "!");
      return {to, from, msg};
    };

    // ‚Äúscript‚Äù line changes with template
    const scriptForTemplate = () => {
      const id = templateSelect.value;
      if(id === "romantic") return "Warm wishes";
      if(id === "funny") return "Ho ho ho!";
      if(id === "coworker") return "Cheers to 2026";
      return "Merry Christmas";
    };

    const render = () => {
      const {to, from, msg} = buildMessage();
      toText.textContent = to || "B·∫°n";
      fromText.textContent = from || "M√¨nh";
      msgText.textContent = msg;
      scriptLine.textContent = scriptForTemplate();
      toStamp.textContent = to || "B·∫°n";
      fromStamp.textContent = from || "M√¨nh";
      updateShareLinks();
    };

    // Tabs logic
    const setTab = (which) => {
      const tabs = [tabEdit, tabView, tabShare];
      tabs.forEach(t => t.classList.remove("active"));

      [stageEdit, stageView, stageShare].forEach(s => s.classList.remove("active"));

      if(which === "edit"){
        tabEdit.classList.add("active");
        stageEdit.classList.add("active");
      }else if(which === "view"){
        tabView.classList.add("active");
        stageView.classList.add("active");
        // Mirror the capture card into view stage
        const mirror = $("viewMirror");
        mirror.innerHTML = "";
        mirror.appendChild($("cardCapture").cloneNode(true));
        // fix ids duplicate: remove canvases in mirror for performance
        mirror.querySelectorAll("canvas").forEach(c=>c.remove());
        showToast("Ch·∫ø ƒë·ªô xem full vibe ‚ú®");
      }else{
        tabShare.classList.add("active");
        stageShare.classList.add("active");
      }

      tabEdit.setAttribute("aria-selected", String(which==="edit"));
      tabView.setAttribute("aria-selected", String(which==="view"));
      tabShare.setAttribute("aria-selected", String(which==="share"));
    };

    tabEdit.addEventListener("click", ()=>setTab("edit"));
    tabView.addEventListener("click", ()=>setTab("view"));
    tabShare.addEventListener("click", ()=>setTab("share"));

    // Switch helper
    const setSwitch = (el, on) => {
      el.dataset.on = String(!!on);
      el.setAttribute("aria-checked", String(!!on));
    };
    const toggleSwitch = (el) => setSwitch(el, el.dataset.on !== "true");

    // Snow / Spark enable
    let snowEnabled = true;
    let sparkEnabled = true;

    const applySwitchStates = () => {
      snowEnabled = (snowSwitch.dataset.on === "true");
      sparkEnabled = (sparkSwitch.dataset.on === "true");
      flipEnabled = (flipSwitch.dataset.on === "true");
    };

    [snowSwitch, sparkSwitch, flipSwitch].forEach(sw=>{
      sw.addEventListener("click", ()=>{ toggleSwitch(sw); applySwitchStates(); });
      sw.addEventListener("keydown", (e)=> {
        if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggleSwitch(sw); applySwitchStates(); }
      });
    });

    // Density
    densityLabel.textContent = densityRange.value;
    densityRange.addEventListener("input", ()=>{
      densityLabel.textContent = densityRange.value;
      resetSnow();
    });

    // Flip behavior
    const doFlip = () => {
      if(!flipEnabled) return showToast("Flip 3D ƒëang t·∫Øt");
      flip.classList.toggle("flipped");
    };
    flipBtn.addEventListener("click", doFlip);
    viewFlipBtn.addEventListener("click", doFlip);
    $("frontSide").addEventListener("click", doFlip);
    $("backSide").addEventListener("click", doFlip);

    // Full screen (simple)
    fullBtn.addEventListener("click", ()=> setTab("view"));

    // Haptic ‚Äúwow‚Äù
    shakeBtn.addEventListener("click", async()=>{
      try{
        if(navigator.vibrate) navigator.vibrate([30, 40, 30]);
        // subtle screen shake
        document.body.animate(
          [{transform:"translateX(0)"},{transform:"translateX(-3px)"},{transform:"translateX(3px)"},{transform:"translateX(0)"}],
          {duration: 260, easing:"ease-in-out"}
        );
        showToast("WOW üí•");
      }catch{}
    });

    // Copy message
    copyBtn.addEventListener("click", async()=>{
      const {msg} = buildMessage();
      try{
        await navigator.clipboard.writeText(msg);
        showToast("ƒê√£ copy l·ªùi ch√∫c üìã");
      }catch{
        showToast("Kh√¥ng copy ƒë∆∞·ª£c (tr√¨nh duy·ªát ch·∫∑n)");
      }
    });

    // Export PNG
    const exportPNG = async() => {
      const node = $("cardCapture");
      try{
        const canvas = await html2canvas(node, {
          backgroundColor: null,
          scale: clamp(window.devicePixelRatio || 1, 1, 2),
          useCORS: true
        });
        canvas.toBlob((blob)=>{
          if(!blob) return showToast("Export th·∫•t b·∫°i");
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `thiep-giangsinh-sieucap-${Date.now()}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          showToast("ƒê√£ t·∫£i PNG ‚¨áÔ∏è");
        }, "image/png", 1);
      }catch{
        showToast("Export th·∫•t b·∫°i ‚Äî th·ª≠ Chrome/Edge");
      }
    };
    downloadBtn.addEventListener("click", exportPNG);
    viewDownloadBtn.addEventListener("click", exportPNG);

    // Music toggle
    musicBtn.addEventListener("click", ()=> setMusic(!musicOn));

    // Gift = confetti burst
    giftBtn.addEventListener("click", ()=>{
      burstConfetti();
      if(navigator.vibrate) navigator.vibrate([25, 30, 25]);
      showToast("üéÅ Merry Christmas!!!");
    });

    // Share tab links
    const baseUrlEl = $("baseUrl");
    const shareUrlEl = $("shareUrl");
    const updateShareLinks = () => {
      const {to, from} = buildMessage();
      const base = location.origin + location.pathname;
      const u = new URL(base);
      if(to) u.searchParams.set("to", to);
      if(from) u.searchParams.set("from", from);
      baseUrlEl.value = base;
      shareUrlEl.value = u.toString();
    };
    copyLinkBtn.addEventListener("click", async()=>{
      try{
        await navigator.clipboard.writeText(shareUrlEl.value);
        showToast("ƒê√£ copy link üîó");
      }catch{
        showToast("Kh√¥ng copy link ƒë∆∞·ª£c");
      }
    });
    openLinkBtn.addEventListener("click", ()=> window.open(shareUrlEl.value, "_blank"));

    // Render bindings
    [toInput, fromInput, templateSelect, customInput].forEach(el=>{
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    // ---------- Snow + Sparkle + Confetti Canvases ----------
    const reducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;

    // canvases for front
    const snow1 = $("snowCanvas"), spark1 = $("sparkCanvas"), confetti = $("confettiCanvas");
    // back
    const snow2 = $("snowCanvas2"), spark2 = $("sparkCanvas2");

    let W=0,H=0, dpr=1;
    let snowFlakes = [];
    let sparkles = [];
    let confettis = [];

    const ctxSnow1 = snow1.getContext("2d");
    const ctxSpark1 = spark1.getContext("2d");
    const ctxConf = confetti.getContext("2d");

    const ctxSnow2 = snow2.getContext("2d");
    const ctxSpark2 = spark2.getContext("2d");

    const resizeCanvases = () => {
      const rect = $("frontSide").getBoundingClientRect();
      W = Math.max(1, Math.floor(rect.width));
      H = Math.max(1, Math.floor(rect.height));
      dpr = clamp(window.devicePixelRatio || 1, 1, 2);

      [snow1, spark1, confetti, snow2, spark2].forEach(c=>{
        c.width = Math.floor(W * dpr);
        c.height = Math.floor(H * dpr);
        c.style.width = W + "px";
        c.style.height = H + "px";
      });
      [ctxSnow1, ctxSpark1, ctxConf, ctxSnow2, ctxSpark2].forEach(ctx=>{
        ctx.setTransform(dpr,0,0,dpr,0,0);
      });

      resetSnow();
      resetSpark();
    };

    const resetSnow = () => {
      const count = clamp(Number(densityRange.value || 90), 20, 200);
      snowFlakes = Array.from({length: reducedMotion ? Math.min(50, count) : count}, ()=>({
        x: Math.random()*W,
        y: Math.random()*H,
        r: 0.6 + Math.random()*2.6,
        vy: 0.7 + Math.random()*1.9,
        vx: -0.5 + Math.random()*1.0,
        a: 0.25 + Math.random()*0.55,
        t: Math.random()*Math.PI*2
      }));
    };

    const resetSpark = () => {
      const count = reducedMotion ? 20 : 46;
      sparkles = Array.from({length: count}, ()=>({
        x: Math.random()*W,
        y: Math.random()*H,
        s: 0.6 + Math.random()*1.8,
        a: 0.15 + Math.random()*0.35,
        p: Math.random()*Math.PI*2,
        v: 0.01 + Math.random()*0.02
      }));
    };

    const drawSnow = (ctx) => {
      ctx.clearRect(0,0,W,H);
      if(!snowEnabled) return;

      ctx.save();
      ctx.globalCompositeOperation = "lighter";
      for(const f of snowFlakes){
        f.t += 0.01;
        f.x += f.vx + Math.sin(f.t)*0.15;
        f.y += f.vy;
        if(f.y > H+10){ f.y = -10; f.x = Math.random()*W; }
        if(f.x < -10) f.x = W+10;
        if(f.x > W+10) f.x = -10;

        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${f.a})`;
        ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    };

    const drawSpark = (ctx) => {
      ctx.clearRect(0,0,W,H);
      if(!sparkEnabled) return;

      ctx.save();
      ctx.globalCompositeOperation = "lighter";
      for(const s of sparkles){
        s.p += s.v;
        const tw = (Math.sin(s.p)*0.5+0.5);
        const a = s.a + tw*0.25;
        const r = s.s + tw*1.2;

        // cross sparkle
        ctx.translate(s.x, s.y);
        ctx.rotate(s.p);
        ctx.beginPath();
        ctx.strokeStyle = `rgba(255,255,255,${a})`;
        ctx.lineWidth = 1.2;
        ctx.moveTo(-r,0); ctx.lineTo(r,0);
        ctx.moveTo(0,-r); ctx.lineTo(0,r);
        ctx.stroke();

        ctx.setTransform(dpr,0,0,dpr,0,0); // reset transform quickly
      }
      ctx.restore();
      // restore transform
      ctx.setTransform(dpr,0,0,dpr,0,0);
    };

    const burstConfetti = () => {
      const n = reducedMotion ? 60 : 140;
      const cx = W*0.72, cy = H*0.28;
      const colors = ["#ffffff", "#22c55e", "#60a5fa", "#f472b6", "#fbbf24"];
      for(let i=0;i<n;i++){
        const ang = Math.random()*Math.PI*2;
        const sp = 2.2 + Math.random()*5.5;
        confettis.push({
          x: cx, y: cy,
          vx: Math.cos(ang)*sp,
          vy: Math.sin(ang)*sp - 1.8,
          g: 0.08 + Math.random()*0.14,
          r: 2 + Math.random()*3,
          w: 6 + Math.random()*8,
          h: 4 + Math.random()*6,
          rot: Math.random()*Math.PI,
          vr: -0.25 + Math.random()*0.5,
          life: 140 + Math.random()*70,
          c: colors[(Math.random()*colors.length)|0],
          a: 0.75 + Math.random()*0.25
        });
      }
    };

    const drawConfetti = () => {
      ctxConf.clearRect(0,0,W,H);
      if(confettis.length === 0) return;
      ctxConf.save();
      ctxConf.globalCompositeOperation = "lighter";

      confettis = confettis.filter(p => p.life > 0);
      for(const p of confettis){
        p.life -= 1;
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;

        ctxConf.translate(p.x, p.y);
        ctxConf.rotate(p.rot);
        ctxConf.fillStyle = p.c;
        ctxConf.globalAlpha = p.a * (p.life/180);
        ctxConf.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        ctxConf.setTransform(dpr,0,0,dpr,0,0);
      }
      ctxConf.restore();
      ctxConf.setTransform(dpr,0,0,dpr,0,0);
    };

    let raf = 0;
    const tick = () => {
      drawSnow(ctxSnow1);
      drawSpark(ctxSpark1);
      drawConfetti();

      drawSnow(ctxSnow2);
      drawSpark(ctxSpark2);

      raf = requestAnimationFrame(tick);
    };

    // ---------- Init ----------
    setSwitch(snowSwitch, true);
    setSwitch(sparkSwitch, true);
    setSwitch(flipSwitch, true);
    applySwitchStates();

    // Build base/share URLs
    $("baseUrl").value = location.origin + location.pathname;

    // First render
    render();

    // Resize observers
    window.addEventListener("resize", ()=> {
      clearTimeout(resizeCanvases._t);
      resizeCanvases._t = setTimeout(resizeCanvases, 80);
    });
    // After layout stable
    setTimeout(resizeCanvases, 60);

    // Start animation
    if(!reducedMotion) tick();

    // Keyboard shortcuts
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") setTab("edit");
      if(e.key.toLowerCase() === "g") burstConfetti();
      if(e.key.toLowerCase() === "m") setMusic(!musicOn);
      if(e.key.toLowerCase() === "f") doFlip();
    });

    // If reduced motion -> still show something static
    if(reducedMotion){
      showToast("Thi·∫øt b·ªã b·∫≠t Reduced Motion ‚Äî gi·∫£m hi·ªáu ·ª©ng ƒë·ªÉ m∆∞·ª£t h∆°n");
    }
  </script>



  async function recordCanvasToVideo({ durationMs = 6000, fps = 60 } = {}) {
  const canvas = document.getElementById("videoCanvas");
  const ctx = canvas.getContext("2d");

  // K√≠ch th∆∞·ªõc video (d·ªçc ki·ªÉu story cho ƒë·∫πp)
  const W = 720, H = 1280;
  canvas.width = W;
  canvas.height = H;

  // L·∫•y n·ªôi dung thi·ªáp hi·ªán t·∫°i t·ª´ form (t·ª± b·∫°n n·ªëi v·ªõi d·ªØ li·ªáu ƒëang c√≥)
  const to = (document.getElementById("toInput")?.value || "B·∫°n").trim();
  const from = (document.getElementById("fromInput")?.value || "M√¨nh").trim();
  const msg = (document.getElementById("msgText")?.textContent || "Merry Christmas!").trim();

  // Stream t·ª´ canvas
  const stream = canvas.captureStream(fps);

  // Ch·ªçn mimeType ∆∞u ti√™n (ƒëa s·ªë ra webm)
  const candidates = [
    "video/webm;codecs=vp9",
    "video/webm;codecs=vp8",
    "video/webm",
    // M·ªôt s·ªë Safari c√≥ th·ªÉ h·ªó tr·ª£ mp4 (kh√¥ng ch·∫Øc)
    "video/mp4"
  ];
  const mimeType = candidates.find(t => window.MediaRecorder && MediaRecorder.isTypeSupported(t)) || "";

  if (!window.MediaRecorder) {
    alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ MediaRecorder ƒë·ªÉ ghi video.");
    return;
  }

  const rec = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
  const chunks = [];
  rec.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };

  // Animation timeline
  const start = performance.now();
  const end = start + durationMs;

  function drawFrame(now) {
    const t = (now - start) / durationMs; // 0..1
    // n·ªÅn gradient + ‚Äúchuy·ªÉn c·∫£nh‚Äù
    ctx.clearRect(0,0,W,H);
    const g = ctx.createLinearGradient(0,0,W,H);
    g.addColorStop(0, `rgba(10,30,20,1)`);
    g.addColorStop(1, `rgba(2,6,23,1)`);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // hi·ªáu ·ª©ng glow ‚Äúƒëi qua‚Äù
    const glowX = W * (0.2 + 0.6 * t);
    const glow = ctx.createRadialGradient(glowX, H*0.25, 10, glowX, H*0.25, 360);
    glow.addColorStop(0, `rgba(255,255,255,${0.18*(1-Math.abs(t-0.5)*2)})`);
    glow.addColorStop(1, "rgba(255,255,255,0)");
    ctx.fillStyle = glow;
    ctx.fillRect(0,0,W,H);

    // tuy·∫øt ƒë∆°n gi·∫£n
    const snowCount = 120;
    for (let i=0;i<snowCount;i++){
      const seed = i * 999;
      const x = (seed % W + (t*W*0.2)) % W;
      const y = ((seed*3) % H + t*H*1.2) % H;
      const r = 1 + (seed % 3);
      ctx.fillStyle = "rgba(255,255,255,0.7)";
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    }

    // Card panel (zoom in)
    const ease = (u) => u<0.5 ? 2*u*u : 1 - Math.pow(-2*u+2,2)/2;
    const z = 0.92 + 0.08*ease(Math.min(1, t*1.1));
    const cardW = W*0.86*z, cardH = H*0.56*z;
    const cardX = (W-cardW)/2, cardY = H*0.22 - (1-z)*120;

    // shadow
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    roundRect(ctx, cardX, cardY+18, cardW, cardH, 34, true, false);

    // glass card
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.lineWidth = 2;
    roundRect(ctx, cardX, cardY, cardW, cardH, 34, true, true);

    // Title
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = "700 44px Inter, system-ui, sans-serif";
    ctx.fillText("Merry Christmas", cardX+34, cardY+70);

    // To
    ctx.fillStyle = "rgba(255,255,255,0.80)";
    ctx.font = "600 22px Inter, system-ui, sans-serif";
    ctx.fillText("G·ª≠i ƒë·∫øn", cardX+34, cardY+110);

    ctx.fillStyle = "rgba(255,255,255,0.98)";
    ctx.font = "800 40px Inter, system-ui, sans-serif";
    ctx.fillText(to, cardX+34, cardY+155);

    // Message (typewriter nh·∫π)
    const typing = Math.min(1, Math.max(0, (t-0.18)/0.55));
    const showLen = Math.floor(msg.length * typing);
    const msgShown = msg.slice(0, showLen);

    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = "500 26px Inter, system-ui, sans-serif";
    wrapText(ctx, msgShown, cardX+34, cardY+220, cardW-68, 34);

    // From + date
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.font = "600 22px Inter, system-ui, sans-serif";
    ctx.fillText(`T·ª´: ${from}`, cardX+34, cardY+cardH-48);

    // little emojis slide in
    const ex = cardX + cardW - 110 + Math.sin(t*6)*6;
    const ey = cardY + 46;
    ctx.font = "44px system-ui";
    ctx.fillText("üéÑ", ex, ey);
    ctx.fillText("‚ú®", ex+46, ey+6);

    if (now < end) {
      requestAnimationFrame(drawFrame);
    } else {
      rec.stop();
    }
  }

  const done = new Promise((resolve) => {
    rec.onstop = () => {
      const blob = new Blob(chunks, { type: rec.mimeType || "video/webm" });
      resolve({ blob, mime: rec.mimeType || "video/webm" });
    };
  });

  rec.start(250);
  requestAnimationFrame(drawFrame);

  return await done;
}

function roundRect(ctx, x, y, w, h, r, fill, stroke) {
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(/\s+/);
  let line = "";
  for (let n=0;n<words.length;n++){
    const testLine = line + words[n] + " ";
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && n>0){
      ctx.fillText(line, x, y);
      line = words[n] + " ";
      y += lineHeight;
    } else line = testLine;
  }
  ctx.fillText(line, x, y);
}

// Hook n√∫t
document.getElementById("recordBtn")?.addEventListener("click", async () => {
  try {
    const { blob, mime } = await recordCanvasToVideo({ durationMs: 6000, fps: 60 });
    const ext = mime.includes("mp4") ? "mp4" : "webm";
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `thiep-giangsinh-video.${ext}`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (e) {
    alert("Kh√¥ng t·∫°o video ƒë∆∞·ª£c. H√£y th·ª≠ Chrome/Edge tr√™n m√°y t√≠nh.");
  }
});
<canvas id="videoCanvas" style="display:none;"></canvas>

</body>
</html>
